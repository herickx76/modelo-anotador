<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Delivery</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: #eef2f5;">

    <header style="background: #111; display: flex; justify-content: space-between; align-items: center;">
        <h1>ğŸ‘¨â€ğŸ³ Cozinha / Admin</h1>
        <button onclick="location.reload()" style="background:transparent; border:1px solid #fff; color:#fff; padding:5px 10px;">Atualizar</button>
    </header>

    <div class="container">
        <div class="dashboard-stats">
            <div class="stat-box">
                <small>Faturamento Hoje</small>
                <h3 id="faturamento-dia">R$ 0,00</h3>
            </div>
            <div class="stat-box">
                <small>Pedidos Pendentes</small>
                <h3 id="total-pendentes">0</h3>
            </div>
        </div>

        <h2 style="margin: 30px 0 15px;">Pedidos em Andamento</h2>
        <div id="lista-pedidos">
            <p>Carregando pedidos...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âš ï¸ USE A MESMA CONFIG
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "clinicahcc-9b1c8.firebaseapp.com",
            databaseURL: "https://clinicahcc-9b1c8-default-rtdb.firebaseio.com",
            projectId: "clinicahcc-9b1c8",
            storageBucket: "clinicahcc-9b1c8.firebasestorage.app",
            messagingSenderId: "238456120590",
            appId: "1:238456120590:web:2c070d10f7e83597d5e35f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Monitorar Pedidos em Tempo Real
        const pedidosRef = ref(db, 'pedidos');
        
        onValue(pedidosRef, (snapshot) => {
            const data = snapshot.val();
            const lista = document.getElementById('lista-pedidos');
            lista.innerHTML = '';
            
            let totalDia = 0;
            let countPendentes = 0;
            const hoje = new Date().toISOString().split('T')[0];

            if(!data) {
                lista.innerHTML = '<p>Sem pedidos no momento.</p>';
                return;
            }

            // Converter objeto em array e ordenar por timestamp (mais recente primeiro)
            const arr = Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();

            arr.forEach(pedido => {
                // CÃ¡lculo Financeiro (SÃ³ soma se finalizado e for de hoje)
                if(pedido.status === 'finalizado' && pedido.data === hoje) {
                    totalDia += pedido.total;
                }
                if(pedido.status === 'pendente') countPendentes++;

                // Renderizar Card
                const card = document.createElement('div');
                card.className = `pedido-card ${pedido.status}`;
                
                // Mapeamento de Status para cores/texto
                let statusTexto = pedido.status.toUpperCase();
                
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <h3>#${pedido.id.slice(-4)} - ${pedido.cliente}</h3>
                        <span style="font-weight:bold;">R$ ${pedido.total.toFixed(2)}</span>
                    </div>
                    <p style="color:#666; font-size:0.9rem;">${pedido.itens}</p>
                    <p style="font-size:0.8rem; margin-top:5px;">ğŸ“ ${pedido.endereco}</p>
                    
                    <div style="margin-top:10px; padding:5px; background:#f0f0f0; display:inline-block; border-radius:5px; font-size:0.8rem;">
                        Status: <strong>${statusTexto}</strong>
                    </div>

                    <div class="status-btn-group">
                        <button class="btn-status" style="background:#3d5afe;" onclick="window.mudarStatus('${pedido.id}', 'preparo')">ğŸ‘¨â€ğŸ³ Em Preparo</button>
                        <button class="btn-status" style="background:#ffea00; color:#000;" onclick="window.mudarStatus('${pedido.id}', 'entrega')">ğŸ›µ Saiu p/ Entrega</button>
                        <button class="btn-status" style="background:#00c853;" onclick="window.mudarStatus('${pedido.id}', 'finalizado')">âœ… Finalizar</button>
                        <button class="btn-status" style="background:#d32f2f;" onclick="window.mudarStatus('${pedido.id}', 'cancelado')">âŒ Cancelar</button>
                    </div>
                `;
                lista.appendChild(card);
            });

            // Atualiza Dashboard
            document.getElementById('faturamento-dia').innerText = `R$ ${totalDia.toFixed(2)}`;
            document.getElementById('total-pendentes').innerText = countPendentes;
        });

        // FunÃ§Ã£o Global para mudar status
        window.mudarStatus = (id, novoStatus) => {
            if(confirm(`Mudar status para ${novoStatus}? O cliente serÃ¡ avisado.`)) {
                update(ref(db, `pedidos/${id}`), { status: novoStatus });
            }
        };
    </script>
</body>
</html>